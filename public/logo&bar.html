<!DOCTYPE html>

<head>
<title>i'm bar logo </title>

<canvas id="canvas"></canvas>
<canvas id="canvas1"></canvas>
<canvas id="canvas3"></canvas>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<!-- <svg id="barcode"></svg> -->
<!-- <svg id="mySvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg> -->
<!-- <svg id="imgbar"></svg> -->

<style>
  #preview{
    width: 350px;
    height: 500px;
    background-color: grey;
    float: left;
    position: relative;
  }
  #product_face{
    background-color: grey;
    float: left;
    margin-left: 10px;
  }
</style>

</head>

<body>
<div>
  <div id="preview"></div>
  <canvas width="350px" height="500px" id="product_face"></canvas>
</div>
<script>
var canvas=document.getElementById("canvas");
var canvas1=document.getElementById("canvas1");
var canvas3 = document.getElementById('canvas3');

// var mySvg = document.getElementById("mySvg");
var ctx3 = canvas3.getContext('2d');
canvas3.width = 600;
    canvas3.height = 600;

canvas.width = 500;
    canvas.height = 500;

    canvas1.width = 500;
    canvas1.height = 500;
    

    var DOMURL = window.URL || window.webkitURL || window || URL;

    
    var brand_name= "Brand B";
  var num = (Math.floor(Math.random() * 10));
  var prod_name= "Product B"+ num; 


var ctx1 = canvas1.getContext("2d");
   var ctx = canvas.getContext("2d");

   var imageObj1 = new Image();
var imageObj2 = new Image();
imageObj1.src = "./l2.png"

imageObj1.onload = function() {
   ctx.drawImage(imageObj1, 10, 30, 228, 226);
   imageObj2.src = "./l1.png";
   imageObj2.onload = function() {
      ctx.drawImage(imageObj2, 50, 10, 300, 326);
   }
};
var imgforl = new Image();

 var imglogo = canvas.toDataURL();
      console.log("i am    ",imglogo)


//     var svglogo = document.createElementNS("http://www.w3.org/2000/svg", "imglogo");
// // new
// svglogo.setAttribute( 'width', '200' );
// svglogo.setAttribute( 'height', '200' );
// svglogo.setAttributeNS("http://www.w3.org/1999/xlink", 'xlink:href', imglogo);
//  document.getElementById("mySvg").appendChild(svglogo);
// imgforl.srcObject = svglogo;



 // var svglogo = new Blob([imgb],{
// type:'base64'
// });

var svglogo=new Blob([imglogo], {
  type: 'image/png;base64'
})

var urllogo = DOMURL.createObjectURL(svglogo);
imgforl.src = urllogo;

console.log(svglogo)
console.log(imgforl)




var imgforb = new Image();

var imgb = new Image();
imgb=JsBarcode("#canvas1", "afw")
// var svgbar = new Blob([imgb]);

// var urlbar = DOMURL.createObjectURL(svgbar);
// imgforb.src = urlbar;
// console.log(imgb)
// console.log(svgbar,urlbar,imgforb)
var imgbar = canvas1.toDataURL();
      console.log("i am    ",imgbar)

//       var svgbar = document.createElementNS("http://www.w3.org/2000/svg", "imgbar");
// // new
// svgbar.setAttribute( 'width', '200' );
// svgbar.setAttribute( 'height', '200' );
// svgbar.setAttributeNS("http://www.w3.org/1999/xlink", 'xlink:href', imgbar);
//  document.getElementById("mySvg").appendChild(svgbar);
// imgforb.srcObject = svgbar;

 var svgbar = new Blob([imgbar], {
  type: 'image/png;base64'
});
var urlbar = DOMURL.createObjectURL(svgbar);
imgforb.src = urlbar;
console.log(imgb)
console.log(svgbar)
console.log(imgforb)     

// // ctx1.drawImage(,0,0)
 

             
//      var imgbar = canvas1.toDataURL();
//       console.log(imgbar)
//       console.log(svg)
// var img = new Image();

// var urlbar = DOMURL.createObjectURL(svg);
// img.src=urlbar

   
      var data='<svg id="r"  xmlns="http://www.w3.org/2000/svg"  width="600" height="550">'+
        // '<defs>'+
        //     '<clipPath id="myCircle">'+
        //        '<circle cx="250" cy="145" r="125" fill="#FFFFFF" />'+
        //     '</clipPath>'+
  '<foreignObject width="100%" height="100%">' +
        //  '</defs>'+ ///clip-path="url(#myCircle)"
        '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:20px">' +
            prod_name +
            '</div>' +
            '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:20px">' +
            brand_name +
            '</div>' +
        '<div xmlns="http://www.w3.org/1999/xhtml" >' +
            '<img width="200" height="250" src="imgforl" />'+
         
         '</div>' +
        '<div xmlns="http://www.w3.org/1999/xhtml" >' +

            '<img width="200" height="250"  src="imgforb" />'+
         '</div>' +
         '</foreignObject>' +


        '</svg>'

  var imgl = new Image();
  var svg1 = new Blob([data], {
  type: 'image/svg+xml;base64'//harset=utf-8
});
console.log(svg1)

var url = DOMURL.createObjectURL(svg1);

// var urllogo = DOMURL.createObjectURL("canvas");

// var urllogo ='<img src="' + url +'">'
//  imgl.src=url
//  console.log(imgl)
//  console.log(url)
 
// function fin() {
    
    imgl.onload = function() {
    console.log("in  ",imgl)
  ctx3.drawImage(imgl, 0, 0);
  console.log("out  ",imgl)
  
   DOMURL.revokeObjectURL(url);
  console.log("revoked  ", url)

 }
// fin()

    //   ctx.drawImage(imgbar, 10, 10, 300, 326);
    //   ctx.drawImage(imglogo, 50, 100, 400, 426);

    //   fsvg=new Blob([data],{
    //       type: 'image/svg+xml;charset=utf-8'
    //   })
    //   var urlf = DOMURL.createObjectURL(fsvg);
     
    
// var urlf = DOMURL.createObjectURL("canvas1");

    //  console.log("werutyuiwerther    iureth    ",document.write('<img src="' + imglogo + '" />'));
    //   var imgf = canvas1.toDataURL();
    //   console.log("i am final",imgf,"  final   ",fsvg," url ",urlf)
    

// ctx3.drawImage(canvas, 0, 0);
// ctx3.drawImage(canvas1, 0, 0);

// var imgfinal = can3.toDataURL();
//       console.log(imgfinal)
   
imgl.src = url;

//fresh start
//
//

// helper functions
function createTextSectionElement(text,styles={background: 'red'}){
  let div = document.createElement('div');
  let p = document.createElement('p')
  p.style.margin = 0;
  p.style.padding = 0;
  p.innerText = text;
  Object.assign(div.style,styles);
  div.setAttribute('xmlns', 'http://www.w3.org/1999/xhtml');
  div.appendChild(p);
  return div;
}

function getBase64Image(img) {
  var canvas = document.createElement("canvas");
  canvas.width = img.width;
  canvas.height = img.height;
  var ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0);
  var dataURL = canvas.toDataURL("image/png");
  return dataURL;
}

function loadURLToData(callback) {
  let xhr = new XMLHttpRequest();
  let element = this;
  xhr.onload = function() {
    var reader = new FileReader();
    reader.onloadend = function() {
      element.src = reader.result;
      callback(reader.result);
    }
    reader.readAsDataURL(xhr.response);
  };
  xhr.open('GET', element.src);
  xhr.responseType = 'blob';
  xhr.send();
}

function render(preview){
  // rendering canvas
  let img_tags_text_wrong = preview.innerHTML.match(/<img.*?>/g); // inner html misses the end tag / of <img>
  let fixed_html_structure = preview.innerHTML;
  img_tags_text_wrong.forEach(wrong_itm=>{
    let img_tag_text_right = wrong_itm.replace('>','/>');
    fixed_html_structure = fixed_html_structure.replace(wrong_itm, img_tag_text_right);
  })

  let html_text_for_render=`<svg id="r"  xmlns="http://www.w3.org/2000/svg">
                              <foreignObject width="100%" height="100%">
                                ${fixed_html_structure}
                              </foreignObject>
                            </svg>`;

  let render_img = new Image();
  let render_svg_blob = new Blob([html_text_for_render], {
    type: 'image/svg+xml;base64'//harset=utf-8
  });
  let render_object_url = DOMURL.createObjectURL(render_svg_blob);
  render_img.onload = function() {
    let product_face_canvas = document.getElementById('product_face');
    let product_face_context = product_face_canvas.getContext("2d");
    product_face_context.drawImage(render_img, 0, 0);
    DOMURL.revokeObjectURL(render_object_url);
  }

  render_img.src = render_object_url;
}

let preview = document.getElementById("preview");
let product_name_section = createTextSectionElement(prod_name, {
  textAlign: 'center',
  'padding-top': '30px',
  'font-size' : '30px',
  'font-weight': 'bold'
});
let brand_name_section = createTextSectionElement(brand_name, {
  textAlign: 'center',
});

// rendering in preview

//barcode
let barcode = new Image();
barcode.src = imgbar;
barcode.setAttribute('xmlns', 'http://www.w3.org/1999/xhtml');
barcode.style.display = 'block';
barcode.style.marginLeft = String(barcode.width/2*-1)+'px';
barcode.style.position = 'absolute';
barcode.style.bottom = '0';
barcode.style.left = '50%';

//logo
let logo = new Image();
logo.src = imageObj1.src;
logo.loadURLToData = loadURLToData;
logo.setAttribute('xmlns', 'http://www.w3.org/1999/xhtml');
logo.style.display = 'block';
logo.style.marginLeft = 'auto';
logo.style.marginRight = 'auto';

preview.appendChild(product_name_section);
preview.appendChild(brand_name_section);
preview.appendChild(logo);
preview.appendChild(barcode);

logo.loadURLToData(function(base64img){
  render(preview);
});

</script>
</body>
</html>